<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Colaborador</title>
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8;
      --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444;
      --brand:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji"; background:linear-gradient(120deg,#0b1021,#0f172a 40%,#0b1021); color:var(--text)}
    .wrap{max-width:760px; margin:4rem auto; padding:1rem}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:18px; padding:28px 24px; box-shadow:0 10px 30px rgba(0,0,0,0.35)}
    h1{margin:0 0 .25rem 0; font-size:1.75rem}
    p.sub{margin:.25rem 0 1.25rem 0; color:var(--muted)}
    label{display:block; font-size:.95rem; margin:.5rem 0 .4rem; color:#cbd5e1}
    input, select, button{width:100%; padding:.85rem 1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:#0b1224; color:var(--text)}
    .actions{margin-top:20px}
    button.submit{background:linear-gradient(90deg,#22d3ee,#60a5fa); border:none; color:#0b1021; font-weight:800; letter-spacing:.2px}
    .toast{position:fixed; right:16px; bottom:16px; background:#0b1224; border:1px solid rgba(255,255,255,.15); padding:12px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); transform:translateY(20px); opacity:0; transition:.2s}
    .toast.show{transform:none; opacity:1}
    .nav_bar{
      background: #111827;
      padding: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 16px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav id="nav" class="nav_bar">
    <a id="menu_dash" href="dashboard.html?company=0" style="color: #e5e7eb; text-decoration: none;">Dashboard</a>
    <a id="menu_comp" href="company.html?company=0" style="color: #e5e7eb; text-decoration: none;">Empresa</a>
    <a id="menu_store" href="store.html?company=0" style="color: #e5e7eb; text-decoration: none;">Loja</a>
    <a id="menu_user" href="user.html?company=0" style="color: #38bdf8; text-decoration: none;">Colaborador</a>
    <a id="menu_logoff" href="/" style="color: #e5e7eb; text-decoration: none;">Sair</a>
  </nav>
<div class="wrap">
  <div class="card">
    <h1>Cadastro de Colaborador</h1>
    <p class="sub">Informe os dados do colaborador e vincule à empresa e loja.</p>

    <form id="collabForm">
      <label for="company_id">Empresa</label>
      <select id="company_id" required>
        <option value="" disabled selected>Carregando empresas…</option>
      </select>

      <label for="store_id">Loja</label>
      <select id="store_id" required>
        <option value="" disabled selected>Selecione uma empresa primeiro</option>
      </select>

      <label for="role">Função</label>
      <select id="role" required>
        <option value="">Selecione…</option>
        <option value="Supervisor(a)">Supervisor(a)</option>
        <option value="Gerente">Gerente</option>
        <option value="Vendedor(a)">Vendedor(a)</option>
        <option value="Auxiliar">Auxiliar</option>
        <option value="Caixa">Caixa</option>
        <option value="Recepcionista">Recepcionista</option>
        <option value="Locutor(a)">Locutor(a)</option>
        <option value="Captador(a)">Captador(a)</option>
      </select>

      <label for="nome">Nome</label>
      <input type="text" id="nome" required placeholder="Nome" />
      
      <div id="credenciais" style="display:none">
        <label for="email">E-mail</label>
        <input type="email" id="email" required placeholder="email@exemplo.com" autocomplete="username"/>
        
        <label for="senha">Senha</label>
        <input type="password" id="senha" required placeholder="Senha de acesso" autocomplete="new-password" />

        <label for="confirme_senha">Confirme Senha</label>
        <input type="password" id="confirme_senha" required placeholder="Confirme sua Senha" autocomplete="new-password"/>
      </div>

      <div class="actions">
        <button class="submit" type="submit">Cadastrar Colaborador</button>
      </div>
    </form>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <h2>Colaboradores Cadastradas</h2>
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.15)">Nome</th>
          <th style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.15)">Função</th>
          <th style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.15)">Loja</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="3" style="text-align:center; padding:8px; color:var(--muted)">Carregando...</td></tr>
      </tbody>
    </table>
  </div>


<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  const API = {
    companies: 'https://webhook.franciscojlalves.com.br/webhook/nps/company',
    stores: 'https://webhook.franciscojlalves.com.br/webhook/nps/store',
    collaborators: 'https://webhook.franciscojlalves.com.br/webhook/collab-intake',
    users: 'https://webhook.franciscojlalves.com.br/webhook/nps/colaborator',
    //sellers: 'https://webhook.franciscojlalves.com.br/webhook/nps/sellers'
  };

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  function generateID(){
    return Date.now() + '-' + Math.floor(Math.random()*1000);
  }

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param) || '';
  }

  const companyFromUrl = getQueryParam('company');

  const dash = document.getElementById('menu_dash')
  dash.href = `dashboard.html?company=${companyFromUrl}`;
  const comp = document.getElementById('menu_comp')
  comp.href = `company.html?company=${companyFromUrl}`;
  const store = document.getElementById('menu_store')
  store.href = `store.html?company=${companyFromUrl}`;
  const user = document.getElementById('menu_user')
  user.href = `user.html?company=${companyFromUrl}`;

  if(companyFromUrl != "0"){
    comp.style.display = "none"
  }

  async function loadCompanys(){
    try {
      const res = await fetch(API.companies);
      const { data } = await res.json();

      let company = [];

      if(companyFromUrl != "0") { 
        company = (data.company || []).filter(s => s.id === companyFromUrl);
        const select = document.getElementById('company_id');
        select.innerHTML = //'<option value="">Selecione…</option>' +
          (company || []).map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
        select.disabled = true;
        loadStoresForCompany(companyFromUrl)
      }else{
        company = data.company;
        const select = document.getElementById('company_id');
        select.innerHTML = '<option value="">Selecione…</option>' +
          (company || []).map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
      }
    } catch {
      toast('Erro ao carregar empresas');
    }
  }

  let lojas = [];

  async function loadStoresForCompany(company_id){
    try {
      const res = await fetch(API.stores);
      const { data } = await res.json();
      lojas = (data.store || []).filter(s => s.company_id === company_id);
      const select = document.getElementById('store_id');
      select.innerHTML = '<option value="">Selecione…</option>' +
        lojas.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');
    } catch {
      toast('Erro ao carregar colaboradores');
    }
  }

  loadUserForCompany(companyFromUrl);

  document.getElementById('company_id').addEventListener('change', function(){
    const company_id = this.value;
    loadStoresForCompany(company_id);
    loadUserForCompany(company_id);
  });

  document.getElementById('collabForm').addEventListener('submit', async function(e){
    e.preventDefault();

    const company_id = document.getElementById('company_id').value.trim();
    const store_id = document.getElementById('store_id').value.trim();
    const role = document.getElementById('role').value.trim();
    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    const senha = document.getElementById('senha').value.trim();
    const confirme_senha = document.getElementById('confirme_senha').value.trim();
    
    if(!company_id || !store_id || !role || !nome || ((role === 'admin' || role === 'manager') && (!email || !senha  || !confirme_senha))) {
      toast('Preencha todos os campos obrigatórios.');
      return;
    }
    
    if(nome.length < 2) {
      toast('O nome precisar ter pelo menos duas letras');
      return;
    }
    
    if(senha !== confirme_senha){
      toast('As senhas precisam ser iguais.');
      return;
    }

    const payload = {
      id: generateID(),
      company_id,
      store_id,
      role,
      nome,
      email,
      senha,
      created_at: new Date().toISOString()
    };

    try {
      const res = await fetch(API.collaborators, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error();
      toast('Colaborador cadastrado com sucesso!');
      document.getElementById('collabForm').reset();
      loadUserForCompany(company_id);
    } catch (err) {
      console.log(err);
      toast('Erro ao cadastrar colaborador.');
    }
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadCompanys);
  } else {
    loadCompanys();
  }

  document.getElementById('role').addEventListener('change', function() {
    const credenciais = document.getElementById('credenciais');
    const email = document.getElementById('email');
    const senha = document.getElementById('senha');
    const confirme_senha = document.getElementById('confirme_senha');
    const role = this.value;

    if(role === 'Supervisor(a)' || role === 'Gerente'){
      credenciais.style.display = 'block';
      email.setAttribute('required', '');
      senha.setAttribute('required', '');
      confirme_senha.setAttribute('required', '');
    } else {
      credenciais.style.display = 'none';
      email.removeAttribute('required');
      senha.removeAttribute('required');
      confirme_senha.removeAttribute('required');
      // limpa os campos
      document.getElementById('email').value = '';
      document.getElementById('senha').value = '';
      document.getElementById('confirme_senha').value = '';
    }
  });

  async function loadUserForCompany(company_id){
    try {
      
      const resColabs = await fetch(API.users);
      var { data } = await resColabs.json();
      const colabs = (data.users || []).filter(s => s.company_id === company_id);
      
      const res = await fetch(API.stores);
      var { data } = await res.json();
      const lojas = (data.store || [])

      let colaborador = [];

      for (let i = 0; i < colabs.length; i++){
        colaborador = colabs[i];  
        for (let j = 0; j < lojas.length; j++){
          if(colabs[i].store_id === lojas[j].id){
            colabs[i]["loja"] = lojas[j].nome;
          }
        }
      }

      colabs.sort(function(a,b) {
        return a.loja < b.loja ? -1 : a.loja > b.loja ? 1 : 0;
      });

      const tbody = document.getElementById('userList');
      if (!colabs || !colabs.length) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:8px; color:var(--muted)">Nenhum colaborador cadastrado(a).</td></tr>';
        return;
      }

      tbody.innerHTML = colabs.map(s => `
        <tr>
          <td style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05)">${s.nome}</td>
          <td style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05)">${s.funcao}</td>
          <td style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05)">${s.loja}</td>
        </tr>
      `).join('');
    } catch (e) {
      document.getElementById('userList').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:8px; color:var(--danger)">Erro ao carregar lojas</td></tr>';
    }
  }

</script>

</body>
</html>
